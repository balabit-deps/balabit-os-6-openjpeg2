From 8f5aff1dff510a964d3901d0fba281abec98ab63 Mon Sep 17 00:00:00 2001
From: Even Rouault <even.rouault@spatialys.com>
Date: Fri, 4 Dec 2020 20:45:25 +0100
Subject: [PATCH] pi.c: avoid out of bounds access with POC (fixes #1302)

---
 src/lib/openjp2/pi.c | 25 +++++++++++++++++++++++--
 1 file changed, 23 insertions(+), 2 deletions(-)

Index: openjpeg2-2.1.2/src/lib/openjp2/pi.c
===================================================================
--- openjpeg2-2.1.2.orig/src/lib/openjp2/pi.c
+++ openjpeg2-2.1.2/src/lib/openjp2/pi.c
@@ -234,7 +234,12 @@ static OPJ_BOOL opj_pi_next_lrcp(opj_pi_
 	opj_pi_comp_t *comp = NULL;
 	opj_pi_resolution_t *res = NULL;
 	OPJ_UINT32 index = 0;
-	
+
+	if (pi->poc.compno0 >= pi->numcomps ||
+			pi->poc.compno1 >= pi->numcomps + 1) {
+		return OPJ_FALSE;
+	}
+
 	if (!pi->first) {
 		comp = &pi->comps[pi->compno];
 		res = &comp->resolutions[pi->resno];
@@ -275,6 +280,11 @@ static OPJ_BOOL opj_pi_next_rlcp(opj_pi_
 	opj_pi_resolution_t *res = NULL;
 	OPJ_UINT32 index = 0;
 
+	if (pi->poc.compno0 >= pi->numcomps ||
+			pi->poc.compno1 >= pi->numcomps + 1) {
+		return OPJ_FALSE;
+	}
+
 	if (!pi->first) {
 		comp = &pi->comps[pi->compno];
 		res = &comp->resolutions[pi->resno];
@@ -314,6 +324,11 @@ static OPJ_BOOL opj_pi_next_rpcl(opj_pi_
 	opj_pi_resolution_t *res = NULL;
 	OPJ_UINT32 index = 0;
 
+	if (pi->poc.compno0 >= pi->numcomps ||
+			pi->poc.compno1 >= pi->numcomps + 1) {
+		return OPJ_FALSE;
+	}
+
 	if (!pi->first) {
 		goto LABEL_SKIP;
 	} else {
