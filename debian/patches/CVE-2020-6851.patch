From 024b8407392cb0b82b04b58ed256094ed5799e04 Mon Sep 17 00:00:00 2001
From: Even Rouault <even.rouault@spatialys.com>
Date: Sat, 11 Jan 2020 01:51:19 +0100
Subject: [PATCH] opj_j2k_update_image_dimensions(): reject images whose
 coordinates are beyond INT_MAX (fixes #1228)

--- a/src/lib/openjp2/j2k.c
+++ b/src/lib/openjp2/j2k.c
@@ -8605,6 +8605,15 @@
         {
                 OPJ_INT32 l_h,l_w;
 
+                if (p_image->x0 > (OPJ_UINT32)INT_MAX ||
+                        p_image->y0 > (OPJ_UINT32)INT_MAX ||
+                        p_image->x1 > (OPJ_UINT32)INT_MAX ||
+                        p_image->y1 > (OPJ_UINT32)INT_MAX) {
+                    opj_event_msg(p_manager, EVT_ERROR,
+                                  "Image coordinates above INT_MAX are not supported\n");
+                    return OPJ_FALSE;
+                }
+
                 l_img_comp->x0 = (OPJ_UINT32)opj_int_ceildiv((OPJ_INT32)p_image->x0, (OPJ_INT32)l_img_comp->dx);
                 l_img_comp->y0 = (OPJ_UINT32)opj_int_ceildiv((OPJ_INT32)p_image->y0, (OPJ_INT32)l_img_comp->dy);
                 l_comp_x1 = opj_int_ceildiv((OPJ_INT32)p_image->x1, (OPJ_INT32)l_img_comp->dx);
@@ -10059,6 +10068,15 @@
         {
                 OPJ_INT32 l_comp_x1, l_comp_y1;
 
+                if (p_image->x0 > (OPJ_UINT32)INT_MAX ||
+                        p_image->y0 > (OPJ_UINT32)INT_MAX ||
+                        p_image->x1 > (OPJ_UINT32)INT_MAX ||
+                        p_image->y1 > (OPJ_UINT32)INT_MAX) {
+                    opj_event_msg(p_manager, EVT_ERROR,
+                                  "Image coordinates above INT_MAX are not supported\n");
+                    return OPJ_FALSE;
+                }
+
                 l_img_comp->factor = p_j2k->m_private_image->comps[compno].factor;
 
                 l_img_comp->x0 = (OPJ_UINT32)opj_int_ceildiv((OPJ_INT32)p_image->x0, (OPJ_INT32)l_img_comp->dx);
