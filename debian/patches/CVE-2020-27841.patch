From 00383e162ae2f8fc951f5745bf1011771acb8dce Mon Sep 17 00:00:00 2001
From: Even Rouault <even.rouault@spatialys.com>
Date: Wed, 2 Dec 2020 14:02:17 +0100
Subject: [PATCH] pi.c: avoid out of bounds access with POC (refs
 https://github.com/uclouvain/openjpeg/issues/1293#issuecomment-737122836)

---
 src/lib/openjp2/pi.c | 49 +++++++++++++++++++++++++++++---------------
 src/lib/openjp2/pi.h | 10 +++++++--
 src/lib/openjp2/t2.c |  4 ++--
 3 files changed, 42 insertions(+), 21 deletions(-)

Index: openjpeg2-2.1.2/src/lib/openjp2/pi.c
===================================================================
--- openjpeg2-2.1.2.orig/src/lib/openjp2/pi.c
+++ openjpeg2-2.1.2/src/lib/openjp2/pi.c
@@ -408,6 +408,11 @@ static OPJ_BOOL opj_pi_next_pcrl(opj_pi_
 	opj_pi_resolution_t *res = NULL;
 	OPJ_UINT32 index = 0;
 
+	if (pi->poc.compno0 >= pi->numcomps ||
+			pi->poc.compno1 >= pi->numcomps + 1) {
+		return OPJ_FALSE;
+	}
+
 	if (!pi->first) {
 		comp = &pi->comps[pi->compno];
 		goto LABEL_SKIP;
@@ -500,6 +505,11 @@ static OPJ_BOOL opj_pi_next_cprl(opj_pi_
 	opj_pi_resolution_t *res = NULL;
 	OPJ_UINT32 index = 0;
 
+	if (pi->poc.compno0 >= pi->numcomps ||
+			pi->poc.compno1 >= pi->numcomps + 1) {
+		return OPJ_FALSE;
+	}
+
 	if (!pi->first) {
 		comp = &pi->comps[pi->compno];
 		goto LABEL_SKIP;
